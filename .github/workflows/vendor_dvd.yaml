name: Vendor DVD CI

on:
  pull_request: {}
  push:
    branches:
    - main
  workflow_dispatch: {}

jobs:
  main:
    name: Build
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: vendor_dvd

    steps:
    - name: Check out sources
      uses: actions/checkout@v4

    - name: Run shellcheck
      run: |
        shellcheck --version
        shellcheck *.sh tests/*.sh ../boot_dvd/internal/vars.sh

    - name: Make ISO using mock inputs
      # We should be able to do `USE_MOCK_INPUTS=1 ./make-iso.sh`, but Docker
      # fails with a read-only bind mount error.
      run: |
        rm -rf inputs
        cp -av tests/inputs/ tests/sha256sum.inputs.txt tests/sha256sum.output.txt .
        ./make-iso.sh

    - name: Check mock ISO
      run: ./tests/test-mock-iso.sh
